# 通讯与调用

## 概述
- 传输协议：TCP（Netty）
- 自定义帧（RpcFrame）：，含魔数、标志位、状态、长度、请求 ID、元数据与业务体
- 元数据（RpcMetaData）：RPC调用基本信息，目前包含 Trace 信息
- 业务体（RpcBody）：当前支持 Protobuf
- 粘拆包：Netty LengthFieldBasedFrameDecoder
- 加解码：Codec
- 调用：像本地调用般简单

---

## 自定义协议

### 结构
```
Header (16 byte)
+-------|-------|-------|-------|-------|-------|-------|--------+
|     magic     | flags |status |             length             |
|-------|-------|-------|-------|-------|-------|-------|--------|
|                           requestId                            |
+-------|-------|-------|-------|-------|-------|-------|--------+

Body (length)
+-------|-------|-------|-------|-------|-------|-------|--------+
|            metaLen            |          rpcMetaData           |
+-------|-------|-------|-------|-------|-------|-------|--------+
|                         rpcMetaData...                         |
+-------|-------|-------|-------|-------|-------|-------|--------+
|                            rpcBody...                          |
+-------|-------|-------|-------|-------|-------|-------|--------+
```
### Header（固定 16 字节）

- magic: 2 byte，常量 0xBB01
- flags: 1 byte，比特位含义：
	- bit0~bit3：protocolType（序列化/业务体协议类型），目前支持 1=Protobuf
	- bit4：请求/响应标志（1=request，0=response）
	- bit5：心跳标志（1=heartbeat）
	- bit6~bit7：预留
- status: 1 byte，传输层状态码，与业务状态无关
- length: 4 byte，body长度，不含帧头
- requestId: 8 byte，请求唯一ID

### Body（body长度）
- metaLen: 4 byte，rpcMetaData 序列化字节长度
- rpcMetaData: 当前使用 Protobuf 协议
- rpcBody: 协议由 protocolType 决定

### RpcBody

- ProtoBuf
    ```protobuf
    syntax="proto3";
    import "google/protobuf/any.proto";
    
    enum RpcStatusCode {
      RPC_SUCCESS = 0;
    
      // 通用错误
      RPC_UNKNOWN_ERROR = 1000; // 未知错误
      RPC_SERVICE_NOT_FOUND_ERROR = 1001; // 服务未找到
      RPC_METHOD_NOT_FOUND_ERROR = 1002; // 方法未找到
      RPC_METHOD_REQUEST_ERROR = 1003; // 请求内容错误
    }
    message RpcBody {
      int32 rpc_id = 1; // 方法唯一标识
      google.protobuf.Any data = 2; // 请求或响应体
      RpcStatusCode statusCode = 3; // 内部状态码
    }
    ```

## 编解码
- 粘拆包：LengthFieldBasedFrameDecoder(maxFrameLength, 4, 4, 8, 0)
	- lengthFieldOffset=4（长度字段偏移量4个字节），lengthFieldLength=4（长度字段占4字节），lengthAdjustment=8（补齐 requestId 8 字节）
- 编码（encode）：按Header+Body顺序写入
- 解码（decode）：按Header+Body顺序读取，校验 magic

## 调用
- JDK 动态代理业务接口，业务接口需要包含：方法名+RpcId字段、具体方法的入参与出参，形如：
  ```java
    public interface UserService {
        int getUserRpcId = 1;
        GetUserRes getUser(GetUserReq req);
    }
  ```

